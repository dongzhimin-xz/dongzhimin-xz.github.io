<!DOCTYPE html><html lang="zh-cn"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="长毛象测试环境搭建"><meta name="keywords" content="言论自由只在这里,踩坑心得"><meta name="author" content="妙瓦草,undefined"><meta name="copyright" content="妙瓦草"><meta name="fediverse:creator" content="@Network@cmx.dzm.pp.ua"><link rel="me" href="https://cmx.dzm.pp.ua/@Network"><title>长毛象测试环境搭建【妙瓦种子】</title><link rel="stylesheet" href="../../../../css/fan.css"><link rel="stylesheet" href="../../../../css/thirdparty/jquery.mCustomScrollbar.min.css"><link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css"><link rel="icon" href="../../../../favicon.ico"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.10.4/dist/instantsearch.min.css"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.10.4/dist/instantsearch-theme-algolia.min.css"><script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.10.4"></script><!-- link(rel="dns-prefetch" href="https://cdn.jsdelivr.net")--><!-- link(rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.1.1/dist/instantsearch.min.css")--><!-- script(src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.1.1/dist/instantsearch.min.js" defer)--><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!-- script(src=url_for("/js/mathjax/mathjax.js"))--><script type="text/x-mathjax-config">MathJax.Hub.Config({
    tex2jax: {inlineMath: [['$', '$'], ['\\(', '\\)']]}
});
</script><script>var isPassword = '' || false;
if (isPassword) {
    if (prompt('请输入文章密码') !== '') {
        alert('密码错误！');
        history.back();
    }
}</script><script>window.GLOBAL_CONFIG = {
  root: '/',
  algolia: {"appId":"BLFJMI3OZT","apiKey":"bfca30d788c8947af1865ed33655b646","indexName":"blog","hits":{"per_page":10},"languages":{"input_placeholder":"搜索文章","hits_empty":"找不到您查询的内容:${query}","hits_stats":"找到 ${hits} 条结果，用时 ${time} 毫秒"}},
  localSearch: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  gitment: {},
  valine: {"appId":"xASAWVJMlgR6Z0IAumJosLmQ-MdYXbMMI","appKey":"hrSzqoj09CVByDzUeBMDEjuF","serverURLs":"https://xasawvjm.api.lncldglobal.com"},
  twikoo: {},
}</script><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="atom.xml" title="妙瓦种子" type="application/atom+xml">
</head><body><canvas id="universe"></canvas><!--#body--><div id="sidebar"><div class="toggle-sidebar-info button-hover"><span data-toggle="文章目录">站点概览</span></div><div class="sidebar-toc"><div class="sidebar-toc-title">目录</div><div class="sidebar-toc-progress"><span class="progress-notice">您已阅读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc-progress-bar"></div></div><div class="sidebar-toc-content" id="sidebar-toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%9D%A2%E5%90%91%E7%9A%84%E8%AF%BB%E8%80%85"><span class="toc-number">1.</span> <span class="toc-text">面向的读者</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Vagrant%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">2.</span> <span class="toc-text">Vagrant的问题</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%99%9A%E6%8B%9F%E6%9C%BA%E8%B8%A9%E5%9D%91%E8%AE%B0"><span class="toc-number">3.</span> <span class="toc-text">虚拟机踩坑记</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#VMWare"><span class="toc-number">3.1.</span> <span class="toc-text">VMWare</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9D%911"><span class="toc-number">3.1.1.</span> <span class="toc-text">坑1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9D%912"><span class="toc-number">3.1.2.</span> <span class="toc-text">坑2</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#VirtualBox"><span class="toc-number">3.2.</span> <span class="toc-text">VirtualBox</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9B%9E%E5%BD%92Vagrant"><span class="toc-number">4.</span> <span class="toc-text">回归Vagrant</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%90%8E%E8%AE%B0"><span class="toc-number">5.</span> <span class="toc-text">后记</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info-avatar"><img class="author-info-avatar-img" src="/avatar.jpg"></div><div class="author-info-name">妙瓦草</div><div class="author-info-description"></div><div class="links-buttons"><a class="links-button button-hover" href="https://github.com/dongzhimin-xz" target="_blank">GitHub<i class="icon-dot bg-color1"></i></a><a class="links-button button-hover" href="https://cmx.dzm.pp.ua/@Network" target="_blank">长毛象<i class="icon-dot bg-color4"></i></a><a class="links-button button-hover" href="https://bsky.app/profile/dzm.pp.ua" target="_blank">BlueSky<i class="icon-dot bg-color2"></i></a></div><div class="author-info-articles"><a class="author-info-articles-archives article-meta" href="../../../../archives"><span class="pull-top">日志</span><span class="pull-bottom">13</span></a><a class="author-info-articles-tags article-meta" href="../../../../tags"><span class="pull-top">标签</span><span class="pull-bottom">22</span></a><a class="author-info-articles-categories article-meta" href="../../../../categories"><span class="pull-top">分类</span><span class="pull-bottom">21</span></a></div><div class="friend-link"><a class="friend-link-text" href="https://dzm.pp.ua/" target="_blank">个人主页</a><a class="friend-link-text" href="https://cmx.dzm.pp.ua/" target="_blank">长毛象实例</a></div></div></div><div id="main-container"><header><div id="menu-outer"><i class="menu-list-icon fas fa-bars"></i><nav id="menu-inner"><a class="menu-item" href="/">首页</a><a class="menu-item" href="/tags">标签</a><a class="menu-item" href="/categories">分类</a><a class="menu-item" href="/archives">归档</a><a class="menu-item" href="/about">关于</a></nav><div class="right-info"><a class="search social-icon"><i class="fas fa-search"></i><span> 搜索</span></a><a class="title-name" href="/">妙瓦种子</a><span id="now-time"></span></div></div></header><div id="content-outer"><div id="content-inner"><article id="post"><div class="post-header"><div class="title">长毛象测试环境搭建</div><div class="container"><time class="button-hover post-date"><i class="fas fa-calendar-alt article-icon" aria-hidden="true"></i> 发表于 2025-08-17 | 更新于 2025-08-18</time><!--time.button-hover.post-date #[i.fas.fa-calendar-alt.article-icon(aria-hidden="true")] #[=__('post.modified')] #[=date(page['updated'], config.date_format)]--><div class="button-hover categories"><i class="fa fa-inbox article-icon" aria-hidden="true"></i><a class="link-a" href="../../../../categories/%E5%BB%BA%E7%AB%99%E6%8A%80%E6%9C%AF/">建站技术</a><i class="fa fa-angle-right" style="margin: 0 8px;"></i><i class="fa fa-inbox article-icon" aria-hidden="true"></i><a class="link-a" href="../../../../categories/%E5%BB%BA%E7%AB%99%E6%8A%80%E6%9C%AF/%E8%B8%A9%E5%9D%91%E5%BF%83%E5%BE%97/">踩坑心得</a></div><div class="button-hover tags"><i class="fa fa-tag article-icon" aria-hidden="true"></i><a class="link-a" href="../../../../tags/%E8%A8%80%E8%AE%BA%E8%87%AA%E7%94%B1%E5%8F%AA%E5%9C%A8%E8%BF%99%E9%87%8C/">言论自由只在这里</a><span>&nbsp;|&nbsp;</span><i class="fa fa-tag article-icon" aria-hidden="true"></i><a class="link-a" href="../../../../tags/%E8%B8%A9%E5%9D%91%E5%BF%83%E5%BE%97/">踩坑心得</a></div></div></div><div class="main-content"><p>我之前就想对长毛象的代码进行深度地魔改，但是对其架构一窍不通，只能一步一步学。<br>对于想要学习别人的代码，就比如超级酷炫的<a target="_blank" rel="noopener" href="https://hello.2heng.xin/">小森林</a>，也需要掌握搭建环境的方法，否则就会发现人家的main分支代码你根本跑不动😄</p>
<span id="more"></span>
<p>到我踩坑之前，我只知道，在<code>vagrant up</code>之后，再<code>git checkout</code>到其他的中版本，甚至大版本，至少需要在这个测试环境走一遍长毛象的更新流程。要么直接<code>vagrant destroy</code>。可到了差不多前两周的时候，我发现新建vagrant实例也不顶用了！于是提交了一个Issue，后来还把<code>Vagrantfile</code>给改了，提交了Pull Request。🥺<br><img src="vagrantPR.png"><br>这是因为我踩坑太多导致改了又改😄<br>官方的管理员似乎也从来都不用vagrant来进行开发。</p>
<h1 id="面向的读者"><a href="#面向的读者" class="headerlink" title="面向的读者"></a>面向的读者</h1><p>这个还是挺实用，难度也是略高的。希望大家都来看看。主要还是给自己看。</p>
<h1 id="Vagrant的问题"><a href="#Vagrant的问题" class="headerlink" title="Vagrant的问题"></a>Vagrant的问题</h1><p><del>这里也不发踩坑的图了，一来没帮助，二来也没这个时间重新踩这个坑</del><br>我翻了一下我一周以前的<a target="_blank" rel="noopener" href="https://cmx.dzm.pp.ua/@Network/115004094040092266">嘟文</a><del>前后的键政别介意哈😄</del><br>原文：</p>
<blockquote>
<p>#技术相关  #长毛象实例升级<br>本来我想写个博客的，但是问题无法解决还是算了🥹<br>昨天我把我的魔改部分合并进长毛象官方分支v4.4，然后用vagrant运行发现不能用了🥹输出的日志显示我魔改的部分代码有问题<br>好，我再检出到官方的v4.4.3版本，原封不动的版本<br>结果它显示缺少libvips，安装了以后又显示libvips版本不够🥹<br>之后还升级了vagrant虚拟机的ubuntu，升到22.04也没用，还有软件版本不够😡<br>最后升到Ubuntu 24.04，惊喜又来了，NFS挂载不了，挂载了以后，又给我报错🙃</p>
</blockquote>
<p>现在分析下来，一开始在我魔改版代码上运行，我的代码本身就是有问题的，它确实与官方v4.4.3版本发生了冲突。此外，“官方纯净版”的长毛象v4.4.3也无法在<code>Vagrantfile</code>所配置的虚拟机上运行。这方面我当时就留意了报错信息，缺少libvips。补上了libvips以后，其他一个接一个的依赖又不行了。我用<code>apt update &amp;&amp; apt search</code>查看了一下版本，发现那个Ubuntu版本的最新版的版本号是远低于长毛象v4.4分支所需版本的。</p>
<p>于是，我就手动升级了vagrant虚拟机的Ubuntu版本。接下来遇到的又一个大坑，就是Ubuntu24.04版的NFS挂载的主机目录，不能有中文！要去掉中文，就得先把NFS从任务管理器给停掉，否则一直占用文件夹，无法改名，没有耐心的小白往往就得把Google关掉重启电脑了😄。</p>
<p><del>来不及为前面的大坑哀悼，</del>紧跟在中文bug后面的大坑是😅，虚拟机内，NFS的这个版本不能用udp挂载。这当然是很后面才处理掉的大坑。</p>
<p>修改<code>Vagrantfile</code>绕开UDP以后，等着我的大坑我记得好像是无法读取文件，反正安装ruby的时候就无法读取版本号，只会安装ruby3.0.0😅进一步的依赖就更别说了</p>
<h1 id="虚拟机踩坑记"><a href="#虚拟机踩坑记" class="headerlink" title="虚拟机踩坑记"></a>虚拟机踩坑记</h1><p>长毛象有一点非常好，就是文档非常完备。为什么长毛象功能这么少，内存消耗那么大，我还要用长毛象呢？因为我是一个技术小白，不论安装什么种类，什么分支的Fedi软件，我都要来看<a target="_blank" rel="noopener" href="https://docs.joinmastodon.org/">长毛象官方文档</a>。这真不是我吹，这是事实。不知道联邦宇宙是不是长毛象的创始人发明的？懂的读者在评论区解释一下🥺</p>
<blockquote>
<p>求求你把网络关闭</p>
</blockquote>
<iframe src="//player.bilibili.com/player.html?isOutside=true&aid=1551468009&bvid=BV1yy421i7cq&cid=1456693714&p=1" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true"></iframe>

<p>我根据官方文档<a target="_blank" rel="noopener" href="https://docs.joinmastodon.org/dev/setup/#manual">https://docs.joinmastodon.org/dev/setup/#manual</a> 安装了长毛象测试环境。又踩了不少坑。<br>首先，长毛象很难在无虚拟机的条件下在Windows下运行，除非使用WSL，本质上还是虚拟机。具体我没试过在Windows下跑长毛象，找了10分钟也没有找到不能在Windows下运行的依赖。总之软件包也不如Linux好管理。</p>
<h2 id="VMWare"><a href="#VMWare" class="headerlink" title="VMWare"></a>VMWare</h2><p>我首先在VMWare上安装了桌面版的Ubuntu。每次都需要花1小时！还需要安装<code>open-vm-tools</code>。</p>
<p>安装了官方文档所述的依赖和正确版本的Ruby以后，运行<code>bundle install</code>和<code>yarn install</code>，创建数据库角色。<br>在长毛象目录使用命令<code>bin/rails db:setup</code>初始化数据库。</p>
<blockquote>
<p>注意⚠：<code>bin/rails db:setup</code>命令会清除数据库！视环境变量而定，在这里会清除开发环境的数据库！</p>
</blockquote>
<p>接着运行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gem install foreman --no-document</span><br><span class="line">foreman start</span><br></pre></td></tr></table></figure>
<p>观察代码发现，在长毛象目录运行<code>bin/dev</code>也是等效的</p>
<p>测试服务器运行后，在浏览器输入<a target="_blank" rel="noopener" href="http://localhost:3000/">http://localhost:3000</a> 即可用官方文档所述的邮箱和密码以站长身份登录测试环境的长毛象实例。</p>
<h3 id="坑1"><a href="#坑1" class="headerlink" title="坑1"></a>坑1</h3><p>以上步骤当你直接在Linux虚拟机内克隆长毛象代码，是肯定能运行的。但是，大坑来了，当你用VMWare共享文件夹，把你的代码文件共享进去，就会卡在<code>yarn install</code>编译失败，<code>foreman start</code>当然也是跑不起来的。它死在了Link这一步。这是因为在VMWare的共享文件夹内，是无法建立软链接的😅。（前面还有一个小坑，就是需要把你操作的非root用户给加入到共享文件夹的组里去）</p>
<h3 id="坑2"><a href="#坑2" class="headerlink" title="坑2"></a>坑2</h3><p>那我把虚拟机内的文件夹共享出来行不行？且不说你辛苦开发的未提交代码会不会跟虚拟机一起随风而去了，光是用SMB共享出来（用<code>网上邻居</code>共享出来）。乍一看你可以用外面的SourceTree各种<code>checkout</code>代码，但到了<code>commit</code>的时候，就会出问题，它提示这个路径不对。<em>反正我人麻了</em>，最后把两个文件拷出来提交了，这波不亏。</p>
<h2 id="VirtualBox"><a href="#VirtualBox" class="headerlink" title="VirtualBox"></a>VirtualBox</h2><p>经过一天的摸鱼Google，第二天下班，我又在VirtualBox重新安装了一遍系统。这里需要用命令行开启允许共享文件夹链接，</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">VBoxManage setextradata YOURVMNAME VBoxInternal2/SharedFoldersEnableSymlinksCreate/YOURSHAREFOLDERNAME <span class="number">1</span>  </span><br><span class="line"># YOURVMNAME为虚拟机中ubuntu系统的名称</span><br><span class="line"># YOURSHAREFOLDERNAME 为共享的目录名称</span><br><span class="line"># 例如：</span><br><span class="line"><span class="function">C:\<span class="title">Program</span> <span class="title">Files</span>\<span class="title">Oracle</span>\<span class="title">VirtualBox</span>\<span class="title">VBoxManage</span> <span class="title">setextradata</span> <span class="title">ubuntu1404</span> <span class="title">VBoxInternal2</span>/<span class="title">SharedFoldersEnableSymlinksCreate</span>/<span class="title">share</span> 1</span></span><br></pre></td></tr></table></figure>
<p>用文本编辑器来编辑虚拟机文件也是可以的。<br>先用<code>ln -s</code>测试了一下，确实可以。接着继续安装环境，<code>yarn install</code>也确实顺利完成了。发现确实可以启动。</p>
<p>美中不足的是，<code>/api/v1/streaming/?</code>的请求会得到500的状态码。具体原因还没吃透。这个坑无伤大雅，部署在生产环境和Vagrant上的长毛象都是101状态码。</p>
<h1 id="回归Vagrant"><a href="#回归Vagrant" class="headerlink" title="回归Vagrant"></a>回归Vagrant</h1><p>Vagrant的原理其实也并不复杂，虽然我至今还没完全吃透😄。<br>这个软件其实也是用Ruby编写的，所以，它出BUG的时候，我还以为虚拟机里的长毛象在用外面的Ruby呢😅。</p>
<p>当你在你的新项目文件夹中，用命令行输入<code>vagrant init</code>时，它会自动生成一个<code>Vagrantfile</code>，也就是长毛象里的那个。这个文件虽然没有后缀，但其实是个ruby文件，遵循ruby语法，你就把它看作一个<code>.rb</code>文件好了。在使用编辑器时，高亮风格设置为Ruby。</p>
<p>这时候就用ruby的语法来解读一下vagrant到底做了什么：<br>在你使用<code>vagrant up</code>的时候，你没有生成过vagrant实例，也没有同名虚拟机，那么它就会正常运行。如果有同名虚拟机，vagrant就不会继续运行。首先它会下载一个vbox，并修改virtualbox虚拟机的配置。还会给你生成一个主机<code>mastodon.local</code>。启动后会挂载文件夹。</p>
<blockquote>
<p>避坑：NFS类型的挂载不顶用了，rsync类型的挂载速度巨慢，把<code>Vagrantfile</code>里那一行的<code>type: &quot;nfs&quot;</code>连着前面后面的逗号和后面的所有参数一起删掉，它就会自动用vbox共享文件夹挂载到<code>Vagrantfile</code>里的同样的位置去，并且自动允许设置软链接。虽然速度稍微慢一点，但是可接受，而且表现更加稳定了。</p>
</blockquote>
<p>vagrant完成上述操作后，就会执行<code>provision</code>代码。也就是<code>Vagrantfile</code>里面安装依赖，并且<strong>初始化数据库</strong>，配置环境变量。</p>
<p>当你已经生成了相关虚拟机了，再运行<code>vagrant up</code>，那么vagrant就会运行除了provision以外的所有<code>Vagrantfile</code>代码。如果需要重新运行一遍provision，那么你只要在vagrant虚拟机启动后，运行一遍<code>vagrant provision</code>即可。为了避免<code>vagrant destroy</code>+<code>vagrant up</code>重装系统浪费时间和梯子流量，建议活用provision代码。</p>
<p>Vagrant的好处在于：当你用<a target="_blank" rel="noopener" href="http://mastodon.local/">http://mastodon.local</a> 登录时，你每次修改完代码，按下保存，系统就会自动刷新浏览器，经过我的测试，这是手动安装测试环境所体现不出来的。</p>
<h1 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h1><p>今天改完实例后，我又研究了一下<a target="_blank" rel="noopener" href="https://hello.2heng.xin/">小森林</a>的代码，想学习一下markdown是怎么实现的。刚开始发现<code>yarn install</code>装不上依赖，发现原来是<code>Vagrantfile</code>没更新过，我把我改出来的代码贴一下</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- mode: ruby -*-</span></span><br><span class="line"><span class="comment"># vi: set ft=ruby :</span></span><br><span class="line"></span><br><span class="line"><span class="variable constant_">ENV</span>[<span class="string">&quot;PORT&quot;</span>] |<span class="params"></span>|= <span class="string">&quot;3000&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$provision</span> = <span class="string">&lt;&lt;SCRIPT</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">cd /vagrant # This is where the host folder/repo is mounted</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># Add the yarn repo + yarn repo keys</span></span><br><span class="line"><span class="string">curl -sS https://dl.yarnpkg.com/debian/pubkey.gpg | sudo apt-key add -</span></span><br><span class="line"><span class="string">sudo apt-add-repository &#x27;deb https://dl.yarnpkg.com/debian/ stable main&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># Add repo for NodeJS</span></span><br><span class="line"><span class="string">curl -sL https://deb.nodesource.com/setup_14.x | sudo bash -</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># Add firewall rule to redirect 80 to PORT and save</span></span><br><span class="line"><span class="string">sudo iptables -t nat -A PREROUTING -p tcp --dport 80 -j REDIRECT --to-port <span class="subst">#&#123;<span class="variable constant_">ENV</span>[<span class="string">&quot;PORT&quot;</span>]&#125;</span></span></span><br><span class="line"><span class="string">echo iptables-persistent iptables-persistent/autosave_v4 boolean true | sudo debconf-set-selections</span></span><br><span class="line"><span class="string">echo iptables-persistent iptables-persistent/autosave_v6 boolean true | sudo debconf-set-selections</span></span><br><span class="line"><span class="string">sudo apt-get install iptables-persistent -y</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># Add packages to build and run Mastodon</span></span><br><span class="line"><span class="string">sudo apt-get install \</span></span><br><span class="line"><span class="string">  git-core \</span></span><br><span class="line"><span class="string">  g++ \</span></span><br><span class="line"><span class="string">  libpq-dev \</span></span><br><span class="line"><span class="string">  libxml2-dev \</span></span><br><span class="line"><span class="string">  libxslt1-dev \</span></span><br><span class="line"><span class="string">  imagemagick \</span></span><br><span class="line"><span class="string">  nodejs \</span></span><br><span class="line"><span class="string">  redis-server \</span></span><br><span class="line"><span class="string">  redis-tools \</span></span><br><span class="line"><span class="string">  postgresql \</span></span><br><span class="line"><span class="string">  postgresql-contrib \</span></span><br><span class="line"><span class="string">  yarn \</span></span><br><span class="line"><span class="string">  libicu-dev \</span></span><br><span class="line"><span class="string">  libidn11-dev \</span></span><br><span class="line"><span class="string">  libreadline-dev \</span></span><br><span class="line"><span class="string">  libpam0g-dev \</span></span><br><span class="line"><span class="string">  -y</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># Install rvm</span></span><br><span class="line"><span class="string">read RUBY_VERSION &lt; .ruby-version</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">curl -sSL https://rvm.io/mpapis.asc | gpg --import</span></span><br><span class="line"><span class="string">curl -sSL https://rvm.io/pkuczynski.asc | gpg --import</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">curl -sSL https://raw.githubusercontent.com/rvm/rvm/stable/binscripts/rvm-installer | bash -s stable --ruby=$RUBY_VERSION</span></span><br><span class="line"><span class="string">source /home/vagrant/.rvm/scripts/rvm</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># Install Ruby</span></span><br><span class="line"><span class="string">rvm reinstall ruby-$RUBY_VERSION --disable-binary</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># Configure database</span></span><br><span class="line"><span class="string">sudo -u postgres createuser -U postgres vagrant -s</span></span><br><span class="line"><span class="string">sudo -u postgres createdb -U postgres mastodon_development</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># Install gems and node modules</span></span><br><span class="line"><span class="string">gem install bundler foreman</span></span><br><span class="line"><span class="string">bundle install</span></span><br><span class="line"><span class="string">yarn install</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># Build Mastodon</span></span><br><span class="line"><span class="string">export RAILS_ENV=development </span></span><br><span class="line"><span class="string">export $(cat &quot;.env.vagrant&quot; | xargs)</span></span><br><span class="line"><span class="string">bundle exec rails db:setup</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># Configure automatic loading of environment variable</span></span><br><span class="line"><span class="string">echo &#x27;export RAILS_ENV=development&#x27; &gt;&gt; ~/.bash_profile</span></span><br><span class="line"><span class="string">echo &#x27;export $(cat &quot;/vagrant/.env.vagrant&quot; | xargs)&#x27; &gt;&gt; ~/.bash_profile</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">SCRIPT</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$start</span> = <span class="string">&lt;&lt;SCRIPT</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">echo &#x27;To start server&#x27;</span></span><br><span class="line"><span class="string">echo &#x27;  $ vagrant ssh -c &quot;cd /vagrant &amp;&amp; foreman start&quot;&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">SCRIPT</span></span><br><span class="line"></span><br><span class="line"><span class="variable constant_">VAGRANTFILE_API_VERSION</span> = <span class="string">&quot;2&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="title class_">Vagrant</span>.configure(<span class="variable constant_">VAGRANTFILE_API_VERSION</span>) <span class="keyword">do</span> |<span class="params">config</span>|</span><br><span class="line"></span><br><span class="line">  config.vm.box = <span class="string">&quot;ubuntu/bionic64&quot;</span></span><br><span class="line"></span><br><span class="line">  config.vm.provider <span class="symbol">:virtualbox</span> <span class="keyword">do</span> |<span class="params">vb</span>|</span><br><span class="line">    vb.name = <span class="string">&quot;little-forest&quot;</span></span><br><span class="line">    vb.customize [<span class="string">&quot;modifyvm&quot;</span>, <span class="symbol">:id</span>, <span class="string">&quot;--memory&quot;</span>, <span class="string">&quot;8192&quot;</span>]</span><br><span class="line">    vb.customize [<span class="string">&quot;modifyvm&quot;</span>, <span class="symbol">:id</span>, <span class="string">&quot;--cpus&quot;</span>, <span class="string">&quot;3&quot;</span>]</span><br><span class="line">    <span class="comment"># Increase the number of CPUs. Uncomment and adjust to</span></span><br><span class="line">    <span class="comment"># increase performance</span></span><br><span class="line">    <span class="comment"># vb.customize [&quot;modifyvm&quot;, :id, &quot;--cpus&quot;, &quot;3&quot;]</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Disable VirtualBox DNS proxy to skip long-delay IPv6 resolutions.</span></span><br><span class="line">    <span class="comment"># https://github.com/mitchellh/vagrant/issues/1172</span></span><br><span class="line">    vb.customize [<span class="string">&quot;modifyvm&quot;</span>, <span class="symbol">:id</span>, <span class="string">&quot;--natdnsproxy1&quot;</span>, <span class="string">&quot;off&quot;</span>]</span><br><span class="line">    vb.customize [<span class="string">&quot;modifyvm&quot;</span>, <span class="symbol">:id</span>, <span class="string">&quot;--natdnshostresolver1&quot;</span>, <span class="string">&quot;off&quot;</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Use &quot;virtio&quot; network interfaces for better performance.</span></span><br><span class="line">    vb.customize [<span class="string">&quot;modifyvm&quot;</span>, <span class="symbol">:id</span>, <span class="string">&quot;--nictype1&quot;</span>, <span class="string">&quot;virtio&quot;</span>]</span><br><span class="line">    vb.customize [<span class="string">&quot;modifyvm&quot;</span>, <span class="symbol">:id</span>, <span class="string">&quot;--nictype2&quot;</span>, <span class="string">&quot;virtio&quot;</span>]</span><br><span class="line"></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># This uses the vagrant-hostsupdater plugin, and lets you</span></span><br><span class="line">  <span class="comment"># access the development site at http://mastodon.local.</span></span><br><span class="line">  <span class="comment"># If you change it, also change it in .env.vagrant before provisioning</span></span><br><span class="line">  <span class="comment"># the vagrant server to update the development build.</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># To install:</span></span><br><span class="line">  <span class="comment">#   $ vagrant plugin install vagrant-hostsupdater</span></span><br><span class="line">  config.vm.hostname = <span class="string">&quot;mastodon.local&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> <span class="keyword">defined</span>?(<span class="title class_">VagrantPlugins</span><span class="symbol">:</span><span class="symbol">:HostsUpdater</span>)</span><br><span class="line">    config.vm.network <span class="symbol">:private_network</span>, <span class="symbol">ip:</span> <span class="string">&quot;192.168.42.42&quot;</span>, <span class="symbol">nictype:</span> <span class="string">&quot;virtio&quot;</span></span><br><span class="line">    config.hostsupdater.remove_on_suspend = <span class="literal">false</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> config.vm.networks.any? &#123; |<span class="params">type, options</span>| type == <span class="symbol">:private_network</span> &#125;</span><br><span class="line">    config.vm.synced_folder <span class="string">&quot;.&quot;</span>, <span class="string">&quot;/vagrant&quot;</span></span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    config.vm.synced_folder <span class="string">&quot;.&quot;</span>, <span class="string">&quot;/vagrant&quot;</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Otherwise, you can access the site at http://localhost:3000 and http://localhost:4000 , http://localhost:8080</span></span><br><span class="line">  config.vm.network <span class="symbol">:forwarded_port</span>, <span class="symbol">guest:</span> <span class="number">3000</span>, <span class="symbol">host:</span> <span class="number">3000</span></span><br><span class="line">  config.vm.network <span class="symbol">:forwarded_port</span>, <span class="symbol">guest:</span> <span class="number">4000</span>, <span class="symbol">host:</span> <span class="number">4000</span></span><br><span class="line">  config.vm.network <span class="symbol">:forwarded_port</span>, <span class="symbol">guest:</span> <span class="number">8080</span>, <span class="symbol">host:</span> <span class="number">8080</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Full provisioning script, only runs on first &#x27;vagrant up&#x27; or with &#x27;vagrant provision&#x27;</span></span><br><span class="line">  config.vm.provision <span class="symbol">:shell</span>, <span class="symbol">inline:</span> <span class="variable">$provision</span>, <span class="symbol">privileged:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Start up script, runs on every &#x27;vagrant up&#x27;</span></span><br><span class="line">  config.vm.provision <span class="symbol">:shell</span>, <span class="symbol">inline:</span> <span class="variable">$start</span>, <span class="symbol">run:</span> <span class="string">&#x27;always&#x27;</span>, <span class="symbol">privileged:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>运行下来，发现main分支确实是他实例的代码。之后的研究过些天再继续。</p>
</div><div class="post-copyright valine" id="comments-container"><script src="//unpkg.com/valine@1.4.14/dist/Valine.min.js"></script><script>let arr = location.href.split('/#more')[0].split('/');
let title = arr[arr.length - 1];
if (title === '') {
    title = arr[arr.length - 2];
}
var flag = false;
var gitFun = function () {
    try {
        var valineObj = window.GLOBAL_CONFIG.valine;
        new Valine({
            el: "#comments-container",
            ...valineObj
        });
        flag = true;
    } catch (e) {
        flag = false;
    }
}
var setIn = setInterval(() => {
    if (!flag) {
        gitFun();
    } else {
        clearInterval(setIn);
    }
}, 200);</script></div></article><div id="pagination"><div class="next-post pull-right"><span class="line line-top"></span><span class="line line-right"></span><span class="line line-bottom"></span><span class="line line-left"></span><a href="../%E9%95%BF%E6%AF%9B%E8%B1%A1%E5%A4%A7%E7%89%88%E6%9C%AC%E6%9B%B4%E6%96%B0%E8%B8%A9%E5%9D%91%E5%BF%83%E5%BE%97/"><span>长毛象大版本更新踩坑心得</span><span>&nbsp;</span><i class="fas fa-angle-right"></i></a></div></div><!--div!= paginator()--></div></div><div class="button-hover" id="return-top"><i class="fas fa-arrow-up" aria-hidden="true"></i></div><footer><div id="footer"><div class="button-hover" id="side-button"><i class="fas fa-arrow-right"></i></div><div class="right-content"><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fas fa-file-o"></i></span><span id="busuanzi_value_page_pv"></span><span></span></div><div class="copyright">&copy;2025 By 妙瓦草</div></div></div></footer></div><!--js(src=url_for(url) + '?version=' + version())--><script src="../../../../js/thirdparty/jquery-3.3.1.min.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="../../../../js/thirdparty/velocity.min.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="../../../../js/thirdparty/jquery.mCustomScrollbar.concat.min.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="../../../../js/fan.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="../../../../js/canvas_bg.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="../../../../js/utils.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="../../../../js/scroll.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="../../../../js/sidebar.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="../../../../js/copy.js"></script><!--script(src=url)--><div class="search-dialog"><div id="algolia-search-title">Algolia</div><div class="search-close-button"><i class="fa fa-times"></i></div><!--div#current-refined-values--><!--div#clear-all--><div id="search-box"></div><!--div#refinement-list--><hr><div id="hits"></div><div id="algolia-pagination"></div></div><div class="search-mask"></div><script src="../../../../js/search/algolia.js"></script></body></html>