<!DOCTYPE html><html lang="zh-cn"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="长毛象markdown代码块高亮"><meta name="keywords" content="言论自由只在这里,踩坑心得,锻🐘大赛冠军,长毛象考古,超长代码预警！！！"><meta name="author" content="妙瓦草,undefined"><meta name="copyright" content="妙瓦草"><meta name="fediverse:creator" content="@Network@cmx.xuzhou-jiang.su"><link rel="me" href="https://cmx.xuzhou-jiang.su/@Network"><title>长毛象markdown代码块高亮【妙瓦种子】</title><link rel="stylesheet" href="../../../../css/fan.css"><link rel="stylesheet" href="../../../../css/thirdparty/jquery.mCustomScrollbar.min.css"><link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css"><link rel="icon" href="../../../../favicon.ico"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.10.4/dist/instantsearch.min.css"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.10.4/dist/instantsearch-theme-algolia.min.css"><script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.10.4"></script><!-- link(rel="dns-prefetch" href="https://cdn.jsdelivr.net")--><!-- link(rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.1.1/dist/instantsearch.min.css")--><!-- script(src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.1.1/dist/instantsearch.min.js" defer)--><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!-- script(src=url_for("/js/mathjax/mathjax.js"))--><script type="text/x-mathjax-config">MathJax.Hub.Config({
    tex2jax: {inlineMath: [['$', '$'], ['\\(', '\\)']]}
});
</script><script>var isPassword = '' || false;
if (isPassword) {
    if (prompt('请输入文章密码') !== '') {
        alert('密码错误！');
        history.back();
    }
}</script><script>window.GLOBAL_CONFIG = {
  root: '/',
  algolia: {"appId":"BLFJMI3OZT","apiKey":"bfca30d788c8947af1865ed33655b646","indexName":"blog","hits":{"per_page":10},"languages":{"input_placeholder":"搜索文章","hits_empty":"找不到您查询的内容:${query}","hits_stats":"找到 ${hits} 条结果，用时 ${time} 毫秒"}},
  localSearch: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  gitment: {},
  valine: {"appId":"xASAWVJMlgR6Z0IAumJosLmQ-MdYXbMMI","appKey":"hrSzqoj09CVByDzUeBMDEjuF","serverURLs":"https://xasawvjm.api.lncldglobal.com"},
  twikoo: {},
}</script><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="atom.xml" title="妙瓦种子" type="application/atom+xml">
</head><body><canvas id="universe"></canvas><!--#body--><div id="sidebar"><div class="toggle-sidebar-info button-hover"><span data-toggle="文章目录">站点概览</span></div><div class="sidebar-toc"><div class="sidebar-toc-title">目录</div><div class="sidebar-toc-progress"><span class="progress-notice">您已阅读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc-progress-bar"></div></div><div class="sidebar-toc-content" id="sidebar-toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%90%86%E8%AE%BA%E5%AD%A6%E4%B9%A0"><span class="toc-number">1.</span> <span class="toc-text">理论学习</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#markdown%E6%98%AF%E4%BB%80%E4%B9%88"><span class="toc-number">1.1.</span> <span class="toc-text">markdown是什么</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"><span class="toc-number">1.2.</span> <span class="toc-text">实现原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%8Emarkdown%E5%88%B0html"><span class="toc-number">1.2.1.</span> <span class="toc-text">从markdown到html</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B0%8F%E6%AE%B5%E4%BB%A3%E7%A0%81%E7%9A%84%E5%88%86%E6%9E%90"><span class="toc-number">1.2.1.1.</span> <span class="toc-text">小段代码的分析</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#coderay"><span class="toc-number">1.2.1.1.1.</span> <span class="toc-text">coderay</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#rouge"><span class="toc-number">1.2.1.1.2.</span> <span class="toc-text">rouge</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-number">2.</span> <span class="toc-text">代码实现</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Ruby-on-Rails"><span class="toc-number">2.1.</span> <span class="toc-text">Ruby on Rails</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Coderay%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-number">2.2.</span> <span class="toc-text">Coderay的使用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#rouge%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-number">2.3.</span> <span class="toc-text">rouge的使用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%98%B2%E6%B3%A8%E5%85%A5Sanitize"><span class="toc-number">2.4.</span> <span class="toc-text">防注入Sanitize</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Sanitize%E8%B8%A9%E5%9D%91%E6%83%85%E5%86%B5"><span class="toc-number">2.4.1.</span> <span class="toc-text">Sanitize踩坑情况</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%95%E5%85%A5%E5%B1%82%E5%8F%A0%E6%A0%B7%E5%BC%8F%E8%A1%A8%EF%BC%88CSS%EF%BC%89"><span class="toc-number">2.5.</span> <span class="toc-text">引入层叠样式表（CSS）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%8F%E6%A3%AE%E6%9E%97scss%E7%9A%84%E5%9D%91"><span class="toc-number">2.5.1.</span> <span class="toc-text">小森林scss的坑</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%A4%A7%E5%9D%91%EF%BC%9A%E6%8D%A2%E8%A1%8C%E9%97%AE%E9%A2%98"><span class="toc-number">3.</span> <span class="toc-text">大坑：换行问题</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info-avatar"><img class="author-info-avatar-img" src="/avatar.jpg"></div><div class="author-info-name">妙瓦草</div><div class="author-info-description"></div><div class="links-buttons"><a class="links-button button-hover" href="https://github.com/dongzhimin-xz" target="_blank">GitHub<i class="icon-dot bg-color10"></i></a><a class="links-button button-hover" href="https://cmx.xuzhou-jiang.su/@Network" target="_blank">长毛象<i class="icon-dot bg-color8"></i></a><a class="links-button button-hover" href="https://bsky.app/profile/dzm.pp.ua" target="_blank">BlueSky<i class="icon-dot bg-color0"></i></a></div><div class="author-info-articles"><a class="author-info-articles-archives article-meta" href="../../../../archives"><span class="pull-top">日志</span><span class="pull-bottom">20</span></a><a class="author-info-articles-tags article-meta" href="../../../../tags"><span class="pull-top">标签</span><span class="pull-bottom">35</span></a><a class="author-info-articles-categories article-meta" href="../../../../categories"><span class="pull-top">分类</span><span class="pull-bottom">28</span></a></div><div class="friend-link"><a class="friend-link-text" href="https://xuzhou-jiang.su/" target="_blank">个人主页</a><a class="friend-link-text" href="https://cmx.xuzhou-jiang.su/" target="_blank">长毛象实例</a></div></div></div><div id="main-container"><header><div id="menu-outer"><i class="menu-list-icon fas fa-bars"></i><nav id="menu-inner"><a class="menu-item" href="/">首页</a><a class="menu-item" href="/tags">标签</a><a class="menu-item" href="/categories">分类</a><a class="menu-item" href="/archives">归档</a><a class="menu-item" href="/about">关于</a></nav><div class="right-info"><a class="search social-icon"><i class="fas fa-search"></i><span> 搜索</span></a><a class="title-name" href="/">妙瓦种子</a><span id="now-time"></span></div></div></header><div id="content-outer"><div id="content-inner"><article id="post"><div class="post-header"><div class="title">长毛象markdown代码块高亮</div><div class="container"><time class="button-hover post-date"><i class="fas fa-calendar-alt article-icon" aria-hidden="true"></i> 发表于 2025-09-01 | 更新于 2025-09-02</time><!--time.button-hover.post-date #[i.fas.fa-calendar-alt.article-icon(aria-hidden="true")] #[=__('post.modified')] #[=date(page['updated'], config.date_format)]--><div class="button-hover categories"><i class="fa fa-inbox article-icon" aria-hidden="true"></i><a class="link-a" href="../../../../categories/%E5%BB%BA%E7%AB%99%E6%8A%80%E6%9C%AF/">建站技术</a><i class="fa fa-angle-right" style="margin: 0 8px;"></i><i class="fa fa-inbox article-icon" aria-hidden="true"></i><a class="link-a" href="../../../../categories/%E5%BB%BA%E7%AB%99%E6%8A%80%E6%9C%AF/%E9%95%BF%E6%AF%9B%E8%B1%A1%E5%BC%80%E5%8F%91/">长毛象开发</a></div><div class="button-hover tags"><i class="fa fa-tag article-icon" aria-hidden="true"></i><a class="link-a" href="../../../../tags/%E8%A8%80%E8%AE%BA%E8%87%AA%E7%94%B1%E5%8F%AA%E5%9C%A8%E8%BF%99%E9%87%8C/">言论自由只在这里</a><span>&nbsp;|&nbsp;</span><i class="fa fa-tag article-icon" aria-hidden="true"></i><a class="link-a" href="../../../../tags/%E8%B8%A9%E5%9D%91%E5%BF%83%E5%BE%97/">踩坑心得</a><span>&nbsp;|&nbsp;</span><i class="fa fa-tag article-icon" aria-hidden="true"></i><a class="link-a" href="../../../../tags/%E9%94%BB%F0%9F%90%98%E5%A4%A7%E8%B5%9B%E5%86%A0%E5%86%9B/">锻🐘大赛冠军</a><span>&nbsp;|&nbsp;</span><i class="fa fa-tag article-icon" aria-hidden="true"></i><a class="link-a" href="../../../../tags/%E9%95%BF%E6%AF%9B%E8%B1%A1%E8%80%83%E5%8F%A4/">长毛象考古</a><span>&nbsp;|&nbsp;</span><i class="fa fa-tag article-icon" aria-hidden="true"></i><a class="link-a" href="../../../../tags/%E8%B6%85%E9%95%BF%E4%BB%A3%E7%A0%81%E9%A2%84%E8%AD%A6%EF%BC%81%EF%BC%81%EF%BC%81/">超长代码预警！！！</a></div></div></div><div class="main-content"><p>我之前写过一篇<a href="/2025/02/01/%E9%95%BF%E6%AF%9B%E8%B1%A1%E5%8F%91%E9%80%81markdown%E5%98%9F%E6%96%87/">长毛象发送markdown嘟文</a>，但是那一篇好像因为太累了，只贴了代码，没详写思路和在网上搜索教程的过程。<br>当初搜索markdown魔改时，中文圈最好的教程就只有这个象友<a target="_blank" rel="noopener" href="https://blog.tantalum.life/posts/notes-on-modifying-mastodon-in-docker/">https://blog.tantalum.life/posts/notes-on-modifying-mastodon-in-docker/</a> <del><em>其实我这才是大型魔改</em></del>。他原话是这么说的😅</p>
<blockquote>
<p>一直很想让长毛象支持 Markdown 语法，但我本人却因为菜得看不懂真代码而多次碰壁。这次使用了小森林站长的 docker 镜像，主题和特色请看这里。</p>
</blockquote>
<p>也就是说，全网最好的长毛象markdown魔改教程，给出的方案是用docker部署小森林分支的代码。<br>后来在本菜鸟的不懈努力下，终于把代码改了。最初能浏览外站markdown，现在总算可以发markdown给别人了。</p>
<p>美中不足的是，我们官方分支的代码块高亮，还差点意思，我也想要<a target="_blank" rel="noopener" href="https://hello.2heng.xin/">小森林</a>的代码块样式🥺</p>
<h1 id="理论学习"><a href="#理论学习" class="headerlink" title="理论学习"></a>理论学习</h1><p>因为我v4.4和他v3.5改终究不是一路人，死抄代码肯定是没用的，必须得理解。</p>
<h2 id="markdown是什么"><a href="#markdown是什么" class="headerlink" title="markdown是什么"></a>markdown是什么</h2><p><a target="_blank" rel="noopener" href="https://hello.2heng.xin/@mashiro/104670343090096501">小森林站长已经介绍了</a></p>
<blockquote>
<p>Markdown 介绍<br>Markdown 是一种轻量级标记语言，创始人为约翰·格鲁伯（John Gruber）。它允许人们“使用易读易写的纯文本格式编写文档，然后转换成有效的 XHTML（或者 HTML）文档”。这种语言吸收了很多在电子邮件中已有的纯文本标记的特性。<br>它的优点：<br>它基于纯文本，方便修改和共享；<br>几乎可以在所有的文本编辑器中编写；<br>有众多编程语言的实现，以及应用的相关扩展；<br>在 GitHub 等网站中有很好的应用；<br>很容易转换为 HTML 文档或其他格式；<br>适合用来编写文档、记录笔记、撰写文章。<br>Markdown 的中文使用说明见：Markdown 入门参考</p>
</blockquote>
<p>当然，那段<code>Markdown 入门参考</code>链接已经失效了。</p>
<h2 id="实现原理"><a href="#实现原理" class="headerlink" title="实现原理"></a>实现原理</h2><p>我们能从中学到什么有用的东西呢？<br>我这hexo博客就是用markdown语言写的。具体语法这里不赘述了，我只教原理，原理会了，语法自然也能掌握了。<br>要进行<a target="_blank" rel="noopener" href="https://blog.tantalum.life/posts/notes-on-modifying-mastodon-in-docker/">大型魔改</a>，就必须理解我在<a href="/2025/02/01/%E9%95%BF%E6%AF%9B%E8%B1%A1%E5%8F%91%E9%80%81markdown%E5%98%9F%E6%96%87/">长毛象发送markdown嘟文</a>中粘贴的代码是什么意思。<br>代码块高亮实现的大致过程：<br>用markdown写的代码块→用html语言表示的代码块→加上css或者style属性，浏览器渲染成五颜六色的样式<br>这个箭头<code>→</code>表示的就是渲染（render）过程。你在代码或英文网页中看到的render就是指将代码变成图画，或者说图像的过程。</p>
<h3 id="从markdown到html"><a href="#从markdown到html" class="headerlink" title="从markdown到html"></a>从markdown到html</h3><p>小森林站长说了，他用的是<code>Kramdown</code>。代码我更是先看了，正如他所说。<br>而长毛象官方分支v4.3~v4.4，也能显示外站的markdown，但官方用的是<code>redcarpet</code>。<br>这次我实现代码高亮，没有改用<code>Kramdown</code>，还是在原有基础上进行修改，使用<code>redcarpet</code>实现。<br>我搜索了如何用redcarpet实现markdown的渲染效果。<a target="_blank" rel="noopener" href="https://github.com/vmg/redcarpet">redcarpet的官方文档</a>说了，首先生成renderer，渲染器可以选择禁用样式、图片、链接。再以刚才的renderer为参数，new一个markdown对象。这个markdown对象的返回值，就是相应的html。</p>
<p>这时，我就试着改了一下<code>:no_styles</code>属性，发现没法改变代码块样式。<br>检查写<a href="/2025/02/01/%E9%95%BF%E6%AF%9B%E8%B1%A1%E5%8F%91%E9%80%81markdown%E5%98%9F%E6%96%87/">这篇文章</a>那会儿抄来的代码，发现原作者（他也是glitch的作者之一，兼长毛象官方分支的管理员）自定义了代码块的渲染</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">HTMLRenderer</span> &lt; <span class="title class_ inherited__">Redcarpet::Render::HTML</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">initialize</span>(<span class="params">options, &amp;block</span>)</span><br><span class="line">      <span class="variable language_">super</span>(options)</span><br><span class="line">      <span class="variable">@format_link</span> = block</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">block_code</span>(<span class="params">code, _language</span>)</span><br><span class="line">      <span class="string">&lt;&lt;~HTML</span></span><br><span class="line"><span class="string">        &lt;pre&gt;&lt;code&gt;<span class="subst">#&#123;<span class="variable constant_">ERB</span><span class="symbol">:</span><span class="symbol">:Util</span>.h(code).gsub(<span class="string">&quot;\n&quot;</span>, <span class="string">&#x27;&lt;br/&gt;&#x27;</span>)&#125;</span>&lt;/code&gt;&lt;/pre&gt;</span></span><br><span class="line"><span class="string">      HTML</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">autolink</span>(<span class="params">link, link_type</span>)</span><br><span class="line">      <span class="keyword">return</span> link <span class="keyword">if</span> link_type == <span class="symbol">:email</span></span><br><span class="line">      <span class="variable">@format_link</span>.call(link)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>其中<code>def block_code(code, _language)</code>这一块，就是渲染代码块的实现。它直接返回html形式的代码块。代码的意思就是，把所有换行符<code>\n</code>都换成html的换行符<code>&lt;br/&gt;</code>。<br>我把这一块给删掉，用redcarpet原生代码块渲染器测试，发现依旧没有样式的迹象。</p>
<h4 id="小段代码的分析"><a href="#小段代码的分析" class="headerlink" title="小段代码的分析"></a>小段代码的分析</h4><p>就按照往期魔改的思路，一段代码要完成的任务很简单，数据输入，数据输出。<strong>输入后和输出前，中间这部分就是我们要研究的，</strong> 输入前和输出后则是只要且必须保证数据类型和格式没有错误就行了。<br>我在公司时，虽然破电脑不能装vagrant，也不适合开发、上传、下载全部的长毛象代码。但是，下载个ruby还是很容易的。再用<code>gem install</code>装个redcarpet，也就等一个钟头而已🤭。<br>装完调试一个hello world。然后就开始渲染markdown的代码块。<br>这段代码，输入的是我用markdown语言写的代码块，输出的是html语言。我只要把html语言复制粘贴到文本文档里，再用浏览器打开就能确认效果。</p>
<p>我发现，这个参数不管怎么改，它输出代码块的样式和类都不会改一点。说明问题不在这里。</p>
<p>在网上搜索了才发现，redcarpet要实现代码高亮，必须安装插件。插件有coderay和rouge。这个rouge就是小森林用的。</p>
<h5 id="coderay"><a href="#coderay" class="headerlink" title="coderay"></a>coderay</h5><p>首先我引入了coderay。输出的html显示，它把样式全都个别地写在元素里。在长毛象一运行，样式会被全部消除！</p>
<h5 id="rouge"><a href="#rouge" class="headerlink" title="rouge"></a>rouge</h5><p>接着我引入了rouge。其实redcarpet也能用rouge。根据网上教程，使用rouge也必须引入css，或者说sass文件。不引入的话，它是没有高亮效果的。样式文件，我直接下载了小森林的，颜色确实很鲜艳。</p>
<h1 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h1><p>前面我学习了coderay和rouge的使用方法。还有Ruby on Rails的代码引入是如何进行的。</p>
<h2 id="Ruby-on-Rails"><a href="#Ruby-on-Rails" class="headerlink" title="Ruby on Rails"></a>Ruby on Rails</h2><p>在Ruby中，每次你要使用其他文件的类和模块时，你都必须在开头<code>require</code>相应的文件。然而，长毛象的文件里，却似乎从来都没有这些。这就跟代码的走向有关了。</p>
<p>平时你运行一个文件，代码从<code>main</code>开始，到<code>main</code>函数的<code>return</code>结束。普通Ruby也许还好，但我们也没时间从零开始学习<code>Hello World</code>。这个Ruby on Rails就复杂得多了。<br>众所周知，长毛象有3个进程，web、sidekiq和streaming。我可以告诉你，streaming进程不是ruby，而是node.js。那就剩下俩，web和sidekiq。web负责接收外站和用户得请求，sidekiq负责进行计算。<br>复杂的就不说了，简化下来，你这个长毛象服务器有两个起点。<br>猴子也懂得解释：</p>
<ol>
<li>站长在ssh敲下<code>systemctl start mastodon-*</code>，或者开机自启时的起点。你就当作长毛象早上来公司上班<br>它上班时，就必须读取<code>config</code>下的所有文件。在测试环境时，<code>config</code>文件夹及其引用的所有文件，仅在启动时读取，其他文件在触发时从硬盘读取。在生产环境中，仅在进程重启时读取所有文件<br>引入代码就在<code>config/application.rb</code></li>
<li>用户和外站数据包进入服务器。此时长毛象已经打卡上班，要么在做领导和客户交代的任务，要么没有任务在那睡觉。这时来办事的用户和外站进来，一脚把我们的客服小祥踢醒<br><img src="huai.jpg"><br>这时，长毛象通过<code>config/routes.rb</code>查找要执行的指令，用<code>serializer</code>将传入的json解析。<br>在这个过程中，就会用到解析markdown的模块。</li>
</ol>
<p>如果你要用<code>require</code>引入代码：</p>
<ul>
<li>如果是第三方代码，就比如要引入<code>rouge</code>，就在<code>Gemfile</code>加入一行</li>
</ul>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gem <span class="string">&#x27;rouge&#x27;</span></span><br></pre></td></tr></table></figure>
<p>这里不需要再在<code>config/application.rb</code>里面<code>require</code>了，因为它里面的<code>Bundler.require(*Rails.groups)</code>已经引入了所有依赖包了，只要你在开始测试或重启长毛象生产环境前，使用<code>bundle install</code>正确安装依赖即可。</p>
<ul>
<li>如果你是引用你自己编写的库，或者其他需要引入的代码，那么就需要在<code>config/application.rb</code>进行引入了。<br>第三方库使用<code>require</code><br>你自己写在项目里的文件，则使用<code>require_relative</code>跟上相对路径</li>
</ul>
<p>但也有例外，极少数情况下，要在对象或模块内进行<code>require</code>。</p>
<h2 id="Coderay的使用"><a href="#Coderay的使用" class="headerlink" title="Coderay的使用"></a>Coderay的使用</h2><p>Coderay直接在<code>def block_code(code, _language)</code>函数内使用即可。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">block_code</span>(<span class="params">code, _language</span>)    </span><br><span class="line">    <span class="title class_">CodeRay</span>.scan(code, _language).div(<span class="symbol">:tab_width=&gt;</span><span class="number">2</span>)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>最好把函数内别的代码删掉。不删掉也可以，把要返回的值放在最后就行。因为Ruby语言中，函数其实不需要使用<code>return</code>（长毛象代码内有使用过），函数的返回值就是最后一个语句的返回值。</p>
</blockquote>
<p>这里直接使用了CodeRay的方法。</p>
<h2 id="rouge的使用"><a href="#rouge的使用" class="headerlink" title="rouge的使用"></a>rouge的使用</h2><p>使用rouge，首先你需要在<code>config/application.rb</code>中单独引入模块</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">require</span> <span class="string">&#x27;rouge/plugins/redcarpet&#x27;</span></span><br></pre></td></tr></table></figure>
<p>再把<code>def block_code(code, _language)</code>函数删掉，直接在renderer中<code>include</code>模块</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">HTMLRenderer</span> &lt; <span class="title class_ inherited__">Redcarpet::Render::HTML</span></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">initialize</span>(<span class="params">options, &amp;block</span>)</span><br><span class="line">    <span class="variable language_">super</span>(options)</span><br><span class="line">    <span class="variable">@format_link</span> = block</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">include</span> <span class="title class_">Rouge::Plugins::Redcarpet</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">autolink</span>(<span class="params">link, link_type</span>)</span><br><span class="line">    <span class="keyword">return</span> link <span class="keyword">if</span> link_type == <span class="symbol">:email</span></span><br><span class="line">    <span class="variable">@format_link</span>.call(link)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p><code>include</code>的意思就是把这个<code>module</code>下的代码整个应用在这个类里面。</p>
<h2 id="防注入Sanitize"><a href="#防注入Sanitize" class="headerlink" title="防注入Sanitize"></a>防注入<code>Sanitize</code></h2><p><code>Sanitize</code>这个类的意思就是<code>消毒</code>的意思。顾名思义，防止用户和外站给你注入恶意代码。<br>注入的形式多种多样，<del>跟某些举报狗和DDOS狗比起来高端多了</del>请求你删库算一种，用markdown和其他富文本更容易实现的就是让其他用户的电脑执行javascript。不仅可以用<code>&lt;script&gt;</code>标签，用<code>style</code>属性也可以执行javascript。<br>修改其实也简单，参考<a target="_blank" rel="noopener" href="https://github.com/dongzhimin-xz/mastodon/commit/c3fe3eea80fb5ceeea6682b0b131ca99cf729180">这个提交</a>进行修改即可。</p>
<h3 id="Sanitize踩坑情况"><a href="#Sanitize踩坑情况" class="headerlink" title="Sanitize踩坑情况"></a>Sanitize踩坑情况</h3><ol>
<li>长毛象的<code>lib/sanitize_ext/sanitize_config.rb</code>需要重启foreman才能生效。<del>折腾了一通宵也真是累了，这也没发现</del></li>
<li>如果sass样式不起作用，把以下语句注释掉看看（仅限测试环境！）</li>
</ol>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Sanitize</span>.node!(<span class="variable">@tree</span>, <span class="title class_">Sanitize</span><span class="symbol">:</span><span class="symbol">:Config</span><span class="symbol">:</span><span class="symbol">:MASTODON_OUTGOING</span>).to_html</span><br></pre></td></tr></table></figure>
<p>如果样式起作用，那就是<code>Sanitize</code>的问题。如果还有搞不明白的谜之bug，请先查看第1条！</p>
<h2 id="引入层叠样式表（CSS）"><a href="#引入层叠样式表（CSS）" class="headerlink" title="引入层叠样式表（CSS）"></a>引入层叠样式表（CSS）</h2><p><code>.scss</code>是种很特殊的文件，看上去是css，其实是Ruby的一部分。<br>因为小森林的代码已经过时了，所以它一拷进来就会引发BUG，因此我对小森林的样式代码<a target="_blank" rel="noopener" href="https://github.com/dongzhimin-xz/mastodon/commit/40b96b97d40ebfab99e1960980e0a4fd210c7d77#diff-925a16ba6a90720daa4c37fbd5bb33f2801dbe8d0bf0650ac234a471621c523c">做了些修改</a>，但结果还是保证原汁原味的。</p>
<h3 id="小森林scss的坑"><a href="#小森林scss的坑" class="headerlink" title="小森林scss的坑"></a>小森林scss的坑</h3><p>因为小森林的主题本来颜色就深，所以看不出来。而我站、glitch分支和官方分支都是粉色的，使用<a target="_blank" rel="noopener" href="https://github.com/dongzhimin-xz/mastodon/commit/40b96b97d40ebfab99e1960980e0a4fd210c7d77#diff-925a16ba6a90720daa4c37fbd5bb33f2801dbe8d0bf0650ac234a471621c523c">这个提交</a>代码块就会显得很奇怪。<br>用F12看了整整两天，发现是这个代码出了问题<br><img src="base.scss.png"><br>改完以后就舒服了</p>
<h1 id="大坑：换行问题"><a href="#大坑：换行问题" class="headerlink" title="大坑：换行问题"></a>大坑：换行问题</h1><p>把以下这段代码改掉以后，就会发现我的代码失去换行能力了</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">block_code</span>(<span class="params">code, _language</span>)</span><br><span class="line">  <span class="string">&lt;&lt;~HTML</span></span><br><span class="line"><span class="string">    &lt;pre&gt;&lt;code&gt;<span class="subst">#&#123;<span class="variable constant_">ERB</span><span class="symbol">:</span><span class="symbol">:Util</span>.h(code).gsub(<span class="string">&quot;\n&quot;</span>, <span class="string">&#x27;&lt;br/&gt;&#x27;</span>)&#125;</span>&lt;/code&gt;&lt;/pre&gt;</span></span><br><span class="line"><span class="string">  HTML</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>我当时解决的办法就是把这段注释掉了</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">def</span> <span class="title function_">format_markdown</span>(<span class="params">html</span>)</span><br><span class="line">    html = markdown_formatter.render(html)</span><br><span class="line"><span class="comment">#   html.delete(&quot;\r&quot;).delete(&quot;\n&quot;)</span></span><br><span class="line">  <span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>刚开始在生产环境看上去挺正常，但两天后就觉得越发不对劲了。我普通地换个行，它就给我分个段。</p>
<p>那么，这一段代码需要修改</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">include</span> <span class="title class_">Rouge::Plugins::Redcarpet</span></span><br></pre></td></tr></table></figure>
<p>可这是个模块，鄙人才疏学浅，不知道该怎么自定义它。于是只能采用这种笨办法了，把<a target="_blank" rel="noopener" href="https://github.com/rouge-ruby/rouge/blob/master/lib/rouge/plugins/redcarpet.rb">rouge源代码</a>给拷过来，再给它返回值加上<code>.gsub!</code>方法</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">diff --git a/app/lib/advanced_text_formatter.rb b/app/lib/advanced_text_formatter.rb</span></span><br><span class="line"><span class="comment">index ec378a71e..703b44437 100644</span></span><br><span class="line"><span class="comment">--- a/app/lib/advanced_text_formatter.rb</span></span><br><span class="line"><span class="comment">+++ b/app/lib/advanced_text_formatter.rb</span></span><br><span class="line"><span class="meta">@@ -6,7 +6,32 @@</span> class AdvancedTextFormatter &lt; TextFormatter</span><br><span class="line">       super(options)</span><br><span class="line">       @format_link = block</span><br><span class="line">     end</span><br><span class="line"><span class="deletion">-    include Rouge::Plugins::Redcarpet</span></span><br><span class="line"><span class="addition">+    include Rouge</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+    def block_code(code, language)</span></span><br><span class="line"><span class="addition">+      lexer =</span></span><br><span class="line"><span class="addition">+        begin</span></span><br><span class="line"><span class="addition">+          Lexer.find_fancy(language, code)</span></span><br><span class="line"><span class="addition">+        rescue Guesser::Ambiguous =&gt; e</span></span><br><span class="line"><span class="addition">+          e.alternatives.first</span></span><br><span class="line"><span class="addition">+        end</span></span><br><span class="line"><span class="addition">+      lexer ||= Lexers::PlainText</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+      # XXX HACK: Redcarpet strips hard tabs out of code blocks,</span></span><br><span class="line"><span class="addition">+      # so we assume you&#x27;re not using leading spaces that aren&#x27;t tabs,</span></span><br><span class="line"><span class="addition">+      # and just replace them here.</span></span><br><span class="line"><span class="addition">+      if lexer.tag == &#x27;make&#x27;</span></span><br><span class="line"><span class="addition">+        code.gsub! %r/^    /, &quot;\t&quot;</span></span><br><span class="line"><span class="addition">+      end</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+      formatter = rouge_formatter(lexer)</span></span><br><span class="line"><span class="addition">+      formatter.format(lexer.lex(code)).gsub!(&quot;\n&quot;, &#x27;&lt;br/&gt;&#x27;)</span></span><br><span class="line">:...skipping...</span><br><span class="line"><span class="comment">diff --git a/app/lib/advanced_text_formatter.rb b/app/lib/advanced_text_formatter.rb</span></span><br><span class="line"><span class="comment">index ec378a71e..703b44437 100644</span></span><br><span class="line"><span class="comment">--- a/app/lib/advanced_text_formatter.rb</span></span><br><span class="line"><span class="comment">+++ b/app/lib/advanced_text_formatter.rb</span></span><br><span class="line"><span class="meta">@@ -6,7 +6,32 @@</span> class AdvancedTextFormatter &lt; TextFormatter</span><br><span class="line">       super(options)</span><br><span class="line">       @format_link = block</span><br><span class="line">     end</span><br><span class="line"><span class="deletion">-    include Rouge::Plugins::Redcarpet</span></span><br><span class="line"><span class="addition">+    include Rouge</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+    def block_code(code, language)</span></span><br><span class="line"><span class="addition">+      lexer =</span></span><br><span class="line"><span class="addition">+        begin</span></span><br><span class="line"><span class="addition">+          Lexer.find_fancy(language, code)</span></span><br><span class="line"><span class="addition">+        rescue Guesser::Ambiguous =&gt; e</span></span><br><span class="line"><span class="addition">+          e.alternatives.first</span></span><br><span class="line"><span class="addition">+        end</span></span><br><span class="line"><span class="addition">+      lexer ||= Lexers::PlainText</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+      # XXX HACK: Redcarpet strips hard tabs out of code blocks,</span></span><br><span class="line"><span class="addition">+      # so we assume you&#x27;re not using leading spaces that aren&#x27;t tabs,</span></span><br><span class="line"><span class="addition">+      # and just replace them here.</span></span><br><span class="line"><span class="addition">+      if lexer.tag == &#x27;make&#x27;</span></span><br><span class="line"><span class="addition">+        code.gsub! %r/^    /, &quot;\t&quot;</span></span><br><span class="line"><span class="addition">+      end</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+      formatter = rouge_formatter(lexer)</span></span><br><span class="line"><span class="addition">+      formatter.format(lexer.lex(code)).gsub!(&quot;\n&quot;, &#x27;&lt;br/&gt;&#x27;)</span></span><br><span class="line"><span class="addition">+    end</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+    # override this method for custom formatting behavior</span></span><br><span class="line"><span class="addition">+    def rouge_formatter(lexer)</span></span><br><span class="line"><span class="addition">+      Formatters::HTMLLegacy.new(:css_class =&gt; &quot;highlight #&#123;lexer.tag&#125;&quot;)</span></span><br><span class="line"><span class="addition">+    end</span></span><br><span class="line"></span><br><span class="line">     def autolink(link, link_type)</span><br><span class="line">       return link if link_type == :email</span><br><span class="line"><span class="meta">@@ -94,7 +119,7 @@</span> class AdvancedTextFormatter &lt; TextFormatter</span><br><span class="line"></span><br><span class="line">   def format_markdown(html)</span><br><span class="line">     html = markdown_formatter.render(html)</span><br><span class="line"><span class="deletion">-#    html.delete(&quot;\r&quot;).delete(&quot;\n&quot;)</span></span><br><span class="line"><span class="addition">+    html.delete(&quot;\r&quot;).delete(&quot;\n&quot;)</span></span><br><span class="line">   end</span><br><span class="line"></span><br><span class="line">   def markdown_formatter</span><br></pre></td></tr></table></figure>

<p>之后效果就好多了。</p>
<p>最后我想说的是</p>
<blockquote>
<p>大型魔改不易，请善待我的实例🥺</p>
</blockquote>
</div><div class="post-copyright valine" id="comments-container"><script src="//unpkg.com/valine@1.4.14/dist/Valine.min.js"></script><script>let arr = location.href.split('/#more')[0].split('/');
let title = arr[arr.length - 1];
if (title === '') {
    title = arr[arr.length - 2];
}
var flag = false;
var gitFun = function () {
    try {
        var valineObj = window.GLOBAL_CONFIG.valine;
        new Valine({
            el: "#comments-container",
            ...valineObj
        });
        flag = true;
    } catch (e) {
        flag = false;
    }
}
var setIn = setInterval(() => {
    if (!flag) {
        gitFun();
    } else {
        clearInterval(setIn);
    }
}, 200);</script></div></article><div id="pagination"><div class="next-post pull-right"><span class="line line-top"></span><span class="line line-right"></span><span class="line line-bottom"></span><span class="line line-left"></span><a href="../bucket-vul/"><span>长毛象泄露存储桶地址的BUG及其修复</span><span>&nbsp;</span><i class="fas fa-angle-right"></i></a></div></div><!--div!= paginator()--></div></div><div class="button-hover" id="return-top"><i class="fas fa-arrow-up" aria-hidden="true"></i></div><footer><div id="footer"><div class="button-hover" id="side-button"><i class="fas fa-arrow-right"></i></div><div class="right-content"><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fas fa-file-o"></i></span><span id="busuanzi_value_page_pv"></span><span></span></div><div class="copyright">&copy;2025 By 妙瓦草</div></div></div></footer></div><!--js(src=url_for(url) + '?version=' + version())--><script src="../../../../js/thirdparty/jquery-3.3.1.min.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="../../../../js/thirdparty/velocity.min.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="../../../../js/thirdparty/jquery.mCustomScrollbar.concat.min.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="../../../../js/fan.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="../../../../js/canvas_bg.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="../../../../js/utils.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="../../../../js/scroll.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="../../../../js/sidebar.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="../../../../js/copy.js"></script><!--script(src=url)--><div class="search-dialog"><div id="algolia-search-title">Algolia</div><div class="search-close-button"><i class="fa fa-times"></i></div><!--div#current-refined-values--><!--div#clear-all--><div id="search-box"></div><!--div#refinement-list--><hr><div id="hits"></div><div id="algolia-pagination"></div></div><div class="search-mask"></div><script src="../../../../js/search/algolia.js"></script></body></html>